{
	"name": "Cannon",
	"source": "http://www.iggamecenter.com/info/en/cannon.html",
	"board": { "height": 10, "width": 10 },
	"graphics": { "icons": {"soldiers":"pawns","flags":"flags"} },
	"setup": { "soldiers": [
		["rectangle",2002,4002,{"owner":1,"dir":5}], ["rectangle",2004,4004,{"owner":1,"dir":5}], ["rectangle",2006,4006,{"owner":1,"dir":5}],
		["rectangle",2008,4008,{"owner":1,"dir":5}], ["rectangle",2010,4010,{"owner":1,"dir":5}],
		["rectangle",7001,9001,{"owner":2,"dir":1}], ["rectangle",7003,9003,{"owner":2,"dir":1}], ["rectangle",7005,9005,{"owner":2,"dir":1}],
		["rectangle",7007,9007,{"owner":2,"dir":1}], ["rectangle",9007,9009,{"owner":2,"dir":1}]
	 ] },
	"terrain": { "townplaces": [ ["rectangle",1002,1009,{"owner":1}], ["rectangle",10002,10009,{"owner":2}] ] },
	"marks": {
		"selectdeploy": {
			"from": "mytownplaces",
			"condition": ["morethan",3,["contextval","turn"]]
		},
		"selecthead": {
			"from": "mysoldiers",
			"condition": ["morethan",["contextval","turn"],2],
			"rungenerators": ["findmovetargets","findkilltargets","findfleetargets","findpotentialtails"],
			"requiredby": ["selecttail","selectmove","selectfire","selectmarch"],
			"cleanse": ["movetarget","potentialtail","killtarget","fleetarget"],
			"requiredby": ["selecttail","selectmove"]
		},
		"selecttail": {
			"from": "potentialtail",
			"rungenerators": ["findphalanxmembers","findmarchandfiretargets"],
			"notifhasmark": ["selectmove"],
			"cleanse": ["phalanxmember","phalanxend","marchtarget","firetarget"],
			"requiredmarks": ["selecthead"],
			"requiredby": ["selectfire","selectmarch"]
		},
		"selectmove": {
			"from": "movetarget",
			"notifhasmark": ["selecttail","selectkill"],
			"requiredmarks": ["selecthead"]
		},
		"selectkill": {
			"from": "killtarget",
			"notifhasmark": ["selecttail","selectmove"],
			"requiredmarks": ["selecthead"]
		},
		"selectfire": {
			"from": "firetarget",
			"notwith": ["selectmarch","selectmove"],
			"cleanse": ["firevictims"],
			"requiredmarks": ["selecthead","selecttail"]
		},
		"selectmarch": {
			"from": "marchtarget",
			"notifhasmark": ["selectfire"],
			"requiredmarks": ["selecthead","selecttail"]
		}
	},
	"commands": {
		"deploy": {
			"requiredmarks": ["selectdeploy"],
			"effect": ["spawnunit","selectdeploy","flags",["contextval","currentplayer"]]
		},
		"move": {
			"requiredmarks": ["selecthead","selectmove"],
			"effect": ["moveunit",["idofunitat","selecthead"],"selectmove"]
		},
		"kill": {
			"requiredmarks": ["selecthead","selectkill"],
			"effect": ["multieffect",[
				["killunit",["idofunitat","selectkill"]],
				["moveunit",["idofunitat","selecthead"],"selectkill"]
			]]
		},
		"march": {
			"requiredmarks": ["selecthead","selecttail","selectmarch"],
			"effect": ["forallin","phalanxmember",
				["offsetunit",["loopid"],["lookup","marchtarget",["markpos","selectmarch"],"heading"],1,0]
			]
		},
		"fire": {
			"requiredmarks": ["selecthead","selectfire"],
			"effect": ["killunit",["idofunitat","selectfire"]]
		}
	},
	"startturn": { "rungenerators": ["findscared"] },
	"endturn": {
		"condition":["same",["contextval","performedsteps"],1],
		"commandcap": true,
		"endgame": {
			"flagkill": {"condition":["notempty","oppdeadflags"],"result":"win"}
		}
	},
	"generators": {
		"findscared": {
			"type": "nextto",
			"starts": "mysoldiers",
			"dirs": ["dirs",[1,2,3,4,5,6,7,8]],
			"condition": ["anyat","oppunits",["contextpos","target"]],
			"draw": {
				"start": {
					"condition": ["truthy",["contextval","neighbourcount"]],
					"tolayer": "scared"
				}
			}
		},
		"findfleetargets": {
			"type": "walker",
			"starts": ["intersect","scared","selecthead"],
			"dirs": ["relativedirs",["dirs",[4,6]],["lookup","units",["contextpos","start"],"dir"]],
			"max": 2,
			"blocks": "units",
			"draw": {
				"steps": {
					"condition": ["same",["contextval","step"],2],
					"tolayer": "movetarget"
				}
			}
		},
		"findmovetargets": {
			"type": "nextto",
			"dirs": ["relativedirs",["dirs",[8,1,2]],["lookup","units",["contextpos","start"],"dir"]],
			"starts": "selecthead",
			"condition": ["noneat","units",["contextpos","target"]],
			"draw": {
				"target": {
					"tolayer":  "movetarget"
				}
			}
		},
		"findkilltargets": {
			"type": "nextto",
			"dirs": ["relativedirs",["dirs",[7,8,1,2,3]],["lookup","units",["contextpos","start"],"dir"]],
			"starts": "selecthead",
			"condition": ["anyat","oppunits",["contextpos","target"]],
			"draw": {
				"target": {
					"tolayer":  "killtarget"
				}
			}
		},
		"findpotentialtails": {
			"type": "walker",
			"dirs": ["dirs",[1,2,3,4,5,6,7,8]],
			"starts": "selecthead",
			"steps": "mysoldiers",
			"max": 2,
			"draw": {
				"steps": {
					"condition": ["same",["contextval","step"],2],
					"tolayer": "potentialtail",
					"include": {
						"headdirection": ["contextval","dir"]
					}
				}
			}
		},
		"findphalanxmembers": {
			"type":"walker",
			"dirs": ["relativedirs",["dirs",[5]],["lookup","potentialtail","selecttail","headdirection"]],
			"starts": "selecttail",
			"blocks": "selecthead",
			"draw": {
				"start": {
					"tolayer": "phalanxend",
					"include": {
						"facing": ["lookup","potentialtail","selecttail","headdirection"]
					}
				},
				"block": {
					"tolayer": "phalanxend",
					"include": {
						"facing": ["contextval","dir"]
					}
				},
				"all": {
					"tolayer": "phalanxmember"
				}
			}
		},
		"findmarchandfiretargets": {
			"type": "walker",
			"starts": "phalanxend",
			"dirs": ["dir",["lookup","phalanxend",["contextpos","start"],"facing"]],
			"blocks": "units",
			"max": 3,
			"draw": {
				"steps": {
					"condition": ["same",["contextval","step"],1],
					"tolayer": "marchtarget",
					"include": {
						"heading": ["contextval","dir"]
					}
				},
				"block": {
					"condition": ["anyat","oppunits",["contextpos","target"]],
					"tolayer": "firetarget"
				}
			}
		}
	}
}