{
	"meta": {
		"name": "Cannon",
		"source": "http://www.iggamecenter.com/info/en/cannon.html",
		"tags": ["formation","chooseaction","kingkill","shoot"]
	},
	"board": { "height": 10, "width": 10 },
	"graphics": { "icons": {"soldiers":"pawns","flags":"kings"} },
	"setup": { "soldiers": [
		["rectangle",2002,4002,1,{"dir":5}], ["rectangle",2004,4004,1,{"dir":5}], ["rectangle",2006,4006,1,{"dir":5}],
		["rectangle",2008,4008,1,{"dir":5}], ["rectangle",2010,4010,1,{"dir":5}],
		["rectangle",7001,9001,2,{"dir":1}], ["rectangle",7003,9003,2,{"dir":1}], ["rectangle",7005,9005,2,{"dir":1}],
		["rectangle",7007,9007,2,{"dir":1}], ["rectangle",7009,9009,2,{"dir":1}]
	 ] },
	"terrain": { "townplaces": [ ["rectangle",1002,1009,1], ["rectangle",10002,10009,2] ] },
	"marks": {
		"selectdeploy": {
			"from": "mytownplaces",
			"allow": ["deploy"]
		},
		"selectunit": {
			"from": "mysoldiers",
			"runGenerators": ["findmovetargets","findkilltargets","findfleetargets","findpotentialtails","findmarchtargets", "findfiretargets" ],
			"allow": [ "selectmove", "selectmarch", "selectfire" ]
		},
		"selectmove": {
			"from": ["union","movetargets","killtargets"],
			"allow": [ "move" ]
		},
		"selectfire": {
			"from": "firetargets",
			"allow": [ "fire" ]
		},
		"selectmarch": {
			"from": "marchtargets",
			"runGenerators": ["findphalanxmembers"],
			"allow": [ "march" ]
		}
	},
	"commands": {
		"deploy": {
			"applyEffects": [ ["spawnunit","selectdeploy","flags",["contextval","currentplayer"]] ]
		},
		"move": {
			"applyEffects": [
				["forallin","selectmove",["killunit",["loopid"]]],
				["move","selectunit","selectmove"]
			]
		},
		"march": {
			"applyEffects": [ ["forallin","phalanx",
				["offsetunit",["loopid"],["lookup","marchtargets","selectmarch","dir"],1,0]
			] ]
		},
		"fire": {
			"applyEffects": [ ["kill","selectfire"] ]
		}
	},
	"startturn": {
		"runGenerators": ["findscared"],
		"allow": [ ["ifelse",["morethan",3,["contextval","turn"]], "selectdeploy", "selectunit" ] ]
	},
	"afterstep": {
		"allow": [ "endturn" ]
	},
	"endturn": {
		"endgame": {
			"flagkill": {"condition":["notempty","oppdeadflags"]}
		}
	},
	"generators": {
		"findscared": {
			"type": "nextto",
			"starts": "mysoldiers",
			"condition": ["anyat","oppunits",["contextpos","target"]],
			"draw": {
				"start": {
					"condition": ["truthy",["contextval","neighbourcount"]],
					"tolayer": "scared"
				}
			}
		},
		"findfleetargets": {
			"type": "walker",
			"starts": ["intersect","scared","selectunit"],
			"dirs": ["relativedirs",["dirs",[4,6]],["lookup","units",["contextpos","start"],"dir"]],
			"max": 2,
			"blocks": "units",
			"draw": {
				"steps": {
					"condition": ["same",["contextval","step"],2],
					"tolayer": "movetargets"
				}
			}
		},
		"findmovetargets": {
			"type": "nextto",
			"dirs": ["relativedirs",["dirs",[8,1,2]],["lookup","units",["contextpos","start"],"dir"]],
			"starts": "selectunit",
			"condition": ["noneat","units",["contextpos","target"]],
			"draw": {
				"target": {
					"tolayer":  "movetargets"
				}
			}
		},
		"findkilltargets": {
			"type": "nextto",
			"dirs": ["relativedirs",["dirs",[7,8,1,2,3]],["lookup","units",["contextpos","start"],"dir"]],
			"starts": "selectunit",
			"condition": ["anyat","oppunits",["contextpos","target"]],
			"draw": {
				"target": {
					"tolayer": "killtargets"
				}
			}
		},
		"findpotentialtails": {
			"type": "nextto",
			"starts": "selectunit",
			"condition": ["anyat","mysoldiers",["contextpos","target"]],
			"draw": {
				"target": {
					"tolayer": "potentialtails",
					"include": {
						"dir": ["contextval","dir"]
					}
				}
			}
		},
		"findmarchtargets": {
			"type": "walker",
			"starts": "potentialtails",
			"dirs": ["relativedir",5,["lookup","potentialtails",["contextpos","start"],"dir"]],
			"steps": "mysoldiers",
			"blocks": ["subtract","board","units"],
			"prioritizeblocksoversteps": true,
			"max": 3,
			"draw": {
				"all": {
					"tolayer": "potentialphalanx",
					"condition": ["and",[
						["same",["contextval","linelength"],2],
						["same",["contextval","stopreason"],"hitblock"]
					]],
					"include": {
						"line": ["dirline",["contextval","dir"]]
					}
				},
				"block": {
					"condition": ["same",["contextval","linelength"],2],
					"tolayer": "marchtargets",
					"include": {
						"line": ["dirline",["contextval","dir"]],
						"dir": ["contextval","dir"]
					}
				}
			}
		},
		"findphalanxmembers": {
			"type": "filter",
			"layer": "potentialphalanx",
			"matching": {
				"line": ["is",["lookup","marchtargets","selectmarch","line"]]
			},
			"tolayer": "phalanx"
		},
		"findfiretargets": {
			"type": "walker",
			"starts": "marchtargets",
			"dirs": ["dir",["lookup","marchtargets",["contextpos","start"],"dir"]],
			"blocks": "units",
			"max": 2,
			"draw": {
				"block": {
					"condition": ["anyat","oppunits",["contextpos","target"]],
					"tolayer": "firetargets"
				}
			}
		}
	}
}