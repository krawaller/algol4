{
	"meta": {
		"name": "Cannon",
		"source": "http://www.iggamecenter.com/info/en/cannon.html"
	},
	"board": { "height": 10, "width": 10 },
	"graphics": { "icons": {"soldiers":"pawns","flags":"kings"} },
	"setup": { "soldiers": [
		["rectangle",2002,4002,1,{"dir":5}], ["rectangle",2004,4004,1,{"dir":5}], ["rectangle",2006,4006,1,{"dir":5}],
		["rectangle",2008,4008,1,{"dir":5}], ["rectangle",2010,4010,1,{"dir":5}],
		["rectangle",7001,9001,2,{"dir":1}], ["rectangle",7003,9003,2,{"dir":1}], ["rectangle",7005,9005,2,{"dir":1}],
		["rectangle",7007,9007,2,{"dir":1}], ["rectangle",7009,9009,2,{"dir":1}]
	 ] },
	"terrain": { "townplaces": [ ["rectangle",1002,1009,1], ["rectangle",10002,10009,2] ] },
	"marks": {
		"selectdeploy": {
			"from": "mytownplaces",
			"allow": [ ["command","deploy"] ]
		},
		"selecthead": {
			"from": "mysoldiers",
			"runGenerators": ["findmovetargets","findkilltargets","findfleetargets","findpotentialtails"],
			"allow": [ ["mark","selecttail"], ["mark","selectmove"] ]
		},
		"selecttail": {
			"from": "potentialtail",
			"runGenerators": ["findphalanxmembers","findmarchandfiretargets"],
			"allow": [ ["mark","selectfire"], ["mark","selectmarch"] ]
		},
		"selectmove": {
			"from": ["union","movetarget","killtarget"],
			"allow": [ ["command","move"] ]
		},
		"selectfire": {
			"from": "firetarget",
			"allow": [ ["command","fire"] ]
		},
		"selectmarch": {
			"from": "marchtarget",
			"allow": [ ["command","march"] ]
		}
	},
	"commands": {
		"deploy": {
			"applyEffects": [ ["spawnunit","selectdeploy","flags",["contextval","currentplayer"]] ]
		},
		"move": {
			"applyEffects": [
				["forallin","selectmove",["killunit",["loopid"]]],
				["moveunit",["idofunitat","selecthead"],"selectmove"]
			]
		},
		"march": {
			"applyEffects": [ ["forallin","phalanxmember",
				["offsetunit",["loopid"],["lookup","marchtarget",["markpos","selectmarch"],"heading"],1,0]
			] ]
		},
		"fire": {
			"applyEffects": [ ["killunit",["idofunitat","selectfire"]] ]
		}
	},
	"startturn": {
		"runGenerators": ["findscared"],
		"allow": [ ["ifelse",["morethan",3,["contextval","turn"]], ["mark","selectdeploy"], ["mark","selecthead"] ] ]
	},
	"afterstep": {
		"allow": [ ["endturn"] ]
	},
	"endturn": {
		"endgame": {
			"flagkill": {"condition":["notempty","oppdeadflags"],"result":"win"}
		}
	},
	"generators": {
		"findscared": {
			"type": "nextto",
			"starts": "mysoldiers",
			"condition": ["anyat","oppunits",["contextpos","target"]],
			"draw": {
				"start": {
					"condition": ["truthy",["contextval","neighbourcount"]],
					"tolayer": "scared"
				}
			}
		},
		"findfleetargets": {
			"type": "walker",
			"starts": ["intersect","scared","selecthead"],
			"dirs": ["relativedirs",["dirs",[4,6]],["lookup","units",["contextpos","start"],"dir"]],
			"max": 2,
			"blocks": "units",
			"draw": {
				"steps": {
					"condition": ["same",["contextval","step"],2],
					"tolayer": "movetarget"
				}
			}
		},
		"findmovetargets": {
			"type": "nextto",
			"dirs": ["relativedirs",["dirs",[8,1,2]],["lookup","units",["contextpos","start"],"dir"]],
			"starts": "selecthead",
			"condition": ["noneat","units",["contextpos","target"]],
			"draw": {
				"target": {
					"tolayer":  "movetarget"
				}
			}
		},
		"findkilltargets": {
			"type": "nextto",
			"dirs": ["relativedirs",["dirs",[7,8,1,2,3]],["lookup","units",["contextpos","start"],"dir"]],
			"starts": "selecthead",
			"condition": ["anyat","oppunits",["contextpos","target"]],
			"draw": {
				"target": {
					"tolayer":  "killtarget"
				}
			}
		},
		"findpotentialtails": {
			"type": "walker",
			"starts": "selecthead",
			"steps": "mysoldiers",
			"max": 2,
			"draw": {
				"steps": {
					"condition": ["same",["contextval","step"],2],
					"tolayer": "potentialtail",
					"include": {
						"headdirection": ["contextval","dir"]
					}
				}
			}
		},
		"findphalanxmembers": {
			"type":"walker",
			"dirs": ["relativedirs",["dirs",[5]],["lookup","potentialtail","selecttail","headdirection"]],
			"starts": "selecttail",
			"blocks": "selecthead",
			"draw": {
				"start": {
					"tolayer": "phalanxend",
					"include": {
						"facing": ["lookup","potentialtail","selecttail","headdirection"]
					}
				},
				"block": {
					"tolayer": "phalanxend",
					"include": {
						"facing": ["contextval","dir"]
					}
				},
				"all": {
					"tolayer": "phalanxmember"
				}
			}
		},
		"findmarchandfiretargets": {
			"type": "walker",
			"starts": "phalanxend",
			"dirs": ["dir",["lookup","phalanxend",["contextpos","start"],"facing"]],
			"blocks": "units",
			"max": 3,
			"draw": {
				"steps": {
					"condition": ["same",["contextval","step"],1],
					"tolayer": "marchtarget",
					"include": {
						"heading": ["contextval","dir"]
					}
				},
				"block": {
					"condition": ["anyat","oppunits",["contextpos","target"]],
					"tolayer": "firetarget"
				}
			}
		}
	}
}