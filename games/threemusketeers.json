{
	"meta": {
		"name": "Three Musketeers",
		"source": "http://www.di.fc.ul.pt/~jpn/gv/3musketeers.htm"
	},
	"graphics": { "icons": {"pawns":"pawns","kings":"kings"}},
	"board": { "height": 5, "width": 5 },
	"setup": {
		"kings": [{"pos":5001,"owner":1},{"pos":3003,"owner":1},{"pos":1005,"owner":1}],
		"pawns": [["holedrectangle",1001,5005,[5001,3003,1005],2]]
	},
	"startturn": {
		"allow": [["mark","selectunit"]]
	},
	"endturn": {
		"endgame": {
			"musketeersinline": {"condition":["notempty","musketeerline"],"who":2},
			"strandedmusketeers": {"condition":["same",["positionsin","strandedmusketeers"],3],"who":1}
		}
	},
	"marks": {
		"selectunit": {
			"from": "myunits",
			"runGenerators": ["findmovetargets"],
			"allow": [["mark","selectmovetarget"]]
		},
		"selectmovetarget": {
			"from": "movetargets",
			"allow": [["command","move"]]
		}
	},
	"commands": {
		"move": {
			"applyEffects": [["kill","selectmovetarget"],["move","selectunit","selectmovetarget"]],
			"runGenerators": ["findmusketeerline",["if",["same",2,["contextval","currentplayer"]],"findstrandedmusketeers"]],
			"allow": [["endturn"]]
		}
	},
	"generators": {
		"findstrandedmusketeers": {
			"type": "nextto",
			"dirs": ["dirs",[1,3,5,7]],
			"starts": "kings",
			"condition": ["anyat","pawns",["contextpos","target"]],
			"draw": {
				"start": {
					"condition": ["falsy",["contextval","neighbourcount"]],
					"tolayer":"strandedmusketeers"
				}
			}
		},
		"findmusketeerline": {
			"type": "walker",
			"dirs": ["dirs",[1,3,5,7]],
			"starts": "kings",
			"count": "kings",
			"draw": {
				"steps": {
					"condition": ["same",2,["contextval","counttotal"]],
					"tolayer": "musketeerline"
				}
			}
		},
		"findmovetargets": {
			"type": "nextto",
			"dirs": ["dirs",[1,3,5,7]],
			"starts": "selectunit",
			"condition": ["ifelse",
				["same",["contextval","currentplayer"],1],
				["anyat","oppunits",["contextpos","target"]],
				["noneat","units",["contextpos","target"]]
			],
			"draw": {
				"target": {
					"tolayer": "movetargets"
				}
			}
		}
	}
}