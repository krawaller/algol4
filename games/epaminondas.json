{
	"source": "https://boardgamegeek.com/filepage/55902/epaminondas-rules-nestorgames",
	"board": {
		"shape": "square",
		"height": 12,
		"width": 14
	},
	"setup": [
		["rectangle",[1001,2014],{"owner":1}],
		["rectangle",[11012,12014],{"owner":2}]
	],
	"terrain": {
		"bases": [
			["rectangle",[1001,2014],{"owner":1}],
			["rectangle",[11012,12014],{"owner":2}]
		]
	},
	"marks": {
		"selecthead": {
			"from": "myunits",
			"hydration": ["findimmediatetargets","finddueltargets","findpotentialtails"],
			"cleanse": ["movetarget","dueltarget","potentialtail"]
		},
		"selecttail": {
			"from": "potentialtail",
			"hydration": ["findphalanxmembers","findmarchandchargetargets","findopposingphalanx"],
			"cleanse": ["phalanxmember","phalanxend","chargetarget","opposingphalanx"]
		},
		"selectmove": {
			"from": "movetarget",
			"notwith": ["selecttail","selectcharge","selectmarch","selectduel"]
		},
		"selectcharge": {
			"from": "chargetarget",
			"notwith": ["selectmarch","selectmove","selectduel"],
			"hydration": ["findchargevictims"],
			"cleanse": ["chargevictims"]
		},
		"selectmarch": {
			"from": "marchtarget",
			"notwith": ["selectcharge","selectmove","selectduel"]
		}
	},
	"commands": {
		"move": {
			"neededmarks": ["selecthead","selectmove"],
			"effects": [
				["moveunit",["idofunitat",["markpos","selecthead"]],["markpos","selectmove"]]
			]
		},
		"march": {
			"neededmarks": ["selecthead","selecttail","selectmarch"],
			"effects": [
				["forallin","phalanxmember",
					["OFFSETUNIT",["loopid"],
						["lookup","marchtarget",["markpos","selectmarch"],"heading"],
						["lookup","marchtarget",["markpos","selectmarch"],"strength",
						0]]
				]
			]
		},
		"charge": {
			"neededmarks": ["selecthead","selecttail","selectcharge"],
			"effects": [
				["forallin","phalanxmember",
					["OFFSETUNIT",["loopid"],
						["lookup","marchtarget",["markpos","selectcharge"],"heading"],
						["lookup","marchtarget",["markpos","selectcharge"],"strength",
						0]]
				],
				["forallin","chargevictims",
					["killunit",["loopid"]]
				]
			]	
		}
	},
	"startturn": {
		"hydration": []
	},
	"endturn": {
		"condition":["same",["contextval","performedsteps"],["val",2]],
		"commandcap": true,
		"endgame": {
			"dominance": {
				"hydration": ["findinfiltrators"],
				"condition": ["morethan",
					["positionsin","myinfiltrators"],
					["positionsin","oppinfiltrators"]
				]
			}
		}
	},
	"generators": {
		"findinfiltrators": {
			"type": "filter",
			"layer": "bases",
			"condition": ["anyat","units",["contextpos","start"]],
			"matching": {"owner":["isnt",["lookup","units",["contextpos","start"],"owner"]]},
			"tolayer": ["ifelse",["anyat","myunits",["contextpos","start"]],"myinfiltrators","oppinfiltrators"]
		},
		"findchargevictims": {
			"type": "filter",
			"layer": "opposingphalanx",
			"matching": {"heading":["is",["lookup","opposingphalanx",["markpos","selectcharge"],"heading"]]},
			"tolayer": "chargevictims"
		},
		"findimmediatetargets": {
			"type": "neighbour",
			"dirs": ["dirs",[1,2,3,4,5,6,7,8]],
			"starts": ["markpos","selecthead"],
			"draw": {
				"target": {
					"condition": ["noneat","units",["contextpos","target"]],
					"tolayer":  "movetarget",
					"include": {
						"singledir": ["contextval","dir"]
					}
				}
			}
		},
		"findpotentialtails": {
			"type": "walker",
			"dirs": ["dirs",[1,2,3,4,5,6,7,8]],
			"starts": ["markpos","selecthead"],
			"steplayer": "myunits",
			"draw": {
				"step": {
					"tolayer": "potentialtail",
					"include": {
						"headdirection": ["contextval","dir"]
					}
				}
			}
		},
		"findphalanxmembers": {
			"type":"walker",
			"dir": ["relativedir",["val",5],["lookup","potentialtail",["markpos","selecttail"],"headdirection"]],
			"starts": ["markpos","selecttail"],
			"stoplayer": "selecthead",
			"draw": {
				"start": {
					"tolayer": "phalanxend",
					"include": {
						"facing": ["lookup","potentialtail",["markpos","selecttail"],"headdirection"],
						"strength": ["contextval","LENGTH"]
					}
				},
				"stop": {
					"tolayer": "phalanxend",
					"include": {
						"facing": ["contextval","dir"],
						"strength": ["contextval","LENGTH"]
					}
				},
				"all": {
					"tolayer": "phalanxmember"
				}
			}
		},
		"findmarchandchargetargets": {
			"type": "walker",
			"starts": ["allposinlayer","phalanxend"],
			"dir": ["lookup","phalanxend",["contextpos","start"],"facing"],
			"stoplayer": "units",
			"max": ["sum",["val",1],["lookup","phalanxend",["contextpos","start"],"strength"]],
			"draw": {
				"step": {
					"tolayer": "marchtarget",
					"include": {
						"strength": ["lookup","phalanxend",["contextpos","start"],"strength"],
						"heading": ["contextval","dir"]
					}
				},
				"stop": {
					"condition": ["anyat","oppunits",["contextpos","target"]],
					"tolayer": "threatened",
					"include": {
						"strength": ["lookup","phalanxend",["contextpos","start"],"strength"],
						"heading": ["contextval","dir"]
					}
				}
			}
		},
		"findopposingphalanx": {
			"type": "walker",
			"starts": ["allposinlayer","threatened"],
			"dir": ["lookup","threatened",["contextpos","start"],"heading"],
			"steplayer": "oppunits",
			"draw": {
				"start": {
					"condition": ["morethan",["lookup","threatened",["contextpos","start"],"strength"],["contextval","LENGTH"]],
					"tolayer": "chargetarget",
					"include": {
						"heading": ["contextval","dir"]
					}
				},
				"all": {
					"tolayer": "opposingphalanx",
					"include": {
						"heading": ["contextval","dir"]
					}
				}
			}
		}
	}
}