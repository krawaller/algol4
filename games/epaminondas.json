{
	"source": "https://boardgamegeek.com/filepage/55902/epaminondas-rules-nestorgames",
	"board": {
		"shape": "square",
		"height": 12,
		"width": 14,
		"setup": [
		]
	},
	"layers": {
		"movetarget": {
			"paintedby": ["findimmediatetargets"],
			"marks": ["selecthead"]
		},
		"potentialdueltarget": {
			"paintedby": ["findimmediatetargets"],
			"startfor": ["finddueltargets"]
		},
		"dueltarget": {
			"paintedby": ["finddueltargets"],
			"marks": ["selectduel"]
		},
		"potentialtail": {
			"paintedby": ["findpotentialtails"],
			"marks": ["selecttail"]
		},
		"phalanxmember": {
			"paintedby": ["findphalanxmembers"]
		},
		"phalanxend": {
			"paintedby": ["findphalanxmembers"]
		},
		"marchtarget": {
			"paintedby": ["findmarchandchargetargets"],
			"marks": ["selectmarch"]
		},
		"threatened": {
			"paintedby": ["findmarchandchargetargets"]
		},
		"chargetarget": {
			"paintedby": ["findopposingphalanx"],
			"marks": ["selectcharge"]
		},
		"opposingphalanx": {
			"paintedby": ["findopposingphalanx"]
		},
		"chargevictims": {
			"paintedby": ["findchargevictims"]
		}
	},
	"flow": {
		"MARK:selecthead": {
			"GENERATOR:findimmediatetargets": ["potentialdueltarget","movetarget"],
			"GENERATOR:finddueltargets": ["dueltarget"],
			"GENERATOR:findpotentialtails": ["potentialtail"],
			"MARK:selectmove": {
				"COMMANDS":["move"]
			},
			"MARK:selectduel": {
				"COMMANDS":["duel"]
			},
			"MARK:selecttail": {
				"GENERATOR:findphalanxmembers": ["phalanxmember","phalanxend"],
				"GENERATOR:findmarchandchargetargets": ["marchtarget","threatened"],
				"GENERATOR:findopposingphalanx": ["chargetarget","opposingphalanx"],
				"MARK:selectcharge": {
					"GENERATOR:findchargevictims": ["chargevictims"],
					"COMMANDS": ["charge"]
				},
				"MARK:selectmarch": {
					"COMMANDS": ["march"]
				}
			}
		}
	},
	"marks": {
		"selecthead": {
			"from": "MYUNITS",
			"hydration": ["findimmediatetargets","finddueltargets","findpotentialtails"],
			"cleanse": ["movetarget","dueltarget","potentialtail"]
		},
		"selecttail": {
			"from": "potentialtail",
			"hydration": ["findphalanxmembers","findmarchandchargetargets","findopposingphalanx"],
			"cleanse": ["phalanxmember","phalanxend","chargetarget","opposingphalanx"]
		},
		"selectmove": {
			"from": "movetarget",
			"notwith": ["selecttail","selectcharge","selectmarch","selectduel"]
		},
		"selectduel": {
			"from": "dueltarget",
			"notwith": ["selecttail","selectcharge","selectmarch","selectmove"]
		},
		"selectcharge": {
			"from": "chargetarget",
			"notwith": ["selectmarch","selectmove","selectduel"],
			"hydration": ["findchargevictims"],
			"cleanse": ["chargevictims"]
		},
		"selectmarch": {
			"from": "marchtarget",
			"notwith": ["selectcharge","selectmove","selectduel"]
		}
	},
	"commands": {
		"move": {
			"neededmarks": ["selecthead","selectmove"],
			"effects": [
				["MOVEUNIT",["IDAT",["MARKPOS","selecthead"]],["MARKPOS","selectmove"]]
			]
		},
		"duel": {
			"neededmarks": ["selecthead","selectduel"],
			"effects": [
				["KILLUNIT",["IDAT",["MARKPOS","selectduel"]]],
				["MOVEUNIT",["IDAT",["MARKPOS","selecthead"]],["MARKPOS","selectduel"]]
			]
		},
		"march": {
			"neededmarks": ["selecthead","selecttail","selectmarch"],
			"effects": [
				["FORALLIN","phalanxmember",
					["OFFSETUNIT",["LOOPID"],
						["LOOKUP","marchtarget",["MARKPOS","selectmarch"],"heading"],
						["LOOKUP","marchtarget",["MARKPOS","selectmarch"],"strength",
						0]]
				]
			]
		},
		"charge": {
			"neededmarks": ["selecthead","selecttail","selectcharge"],
			"effects": [
				["FORALLIN","phalanxmember",
					["OFFSETUNIT",["LOOPID"],
						["LOOKUP","marchtarget",["MARKPOS","selectcharge"],"heading"],
						["LOOKUP","marchtarget",["MARKPOS","selectcharge"],"strength",
						0]]
				],
				["FORALLIN","chargevictims",
					["KILLUNIT",["LOOPID"]]
				]
			]	
		}
	},
	"startturn": {
		"hydration": []
	},
	"generators": {
		"findchargevictims": {
			"type": "filter",
			"layer": "opposingphalanx",
			"matching": {"heading":["IS",["LOOKUP","opposingphalanx",["MARKPOS","selectcharge"],"heading"]]},
			"tolayer": "chargevictims"
		},
		"findimmediatetargets": {
			"type": "neighbour",
			"dirs": ["DIRS",[1,2,3,4,5,6,7,8]],
			"start": ["MARKPOS","selecthead"],
			"draw": {
				"target": {
					"condition": ["NONEAT","MYUNITS",["CONTEXTPOS","TARGET"]],
					"tolayer": ["IFELSE",
						["ANYAT","OPPUNITS",["CONTEXTPOS","TARGET"]],
						"potentialdueltarget",
						"movetarget"
					],
					"include": {
						"singledir": ["CONTEXTVAL","DIR"]
					}
				}
			}
		},
		"finddueltargets": {
			"type": "neighbour",
			"start": ["ALLPOSINLAYER","potentialdueltarget"],
			"dirs": ["RELATIVEDIRS",[1],["LOOKUP",["CONTEXTPOS","START"],"singledir"]],
			"draw": {
				"start": {
					"condition": ["NONEAT","OPPUNITS",["CONTEXTPOS","TARGET"]],
					"tolayer": "dueltarget"
				}
			}
		},
		"findpotentialtails": {
			"type": "walker",
			"dirs": ["DIRS",[1,2,3,4,5,6,7,8]],
			"start": ["MARKPOS","selecthead"],
			"steplayer": "MYUNITS",
			"draw": {
				"step": {
					"tolayer": "potentialtail",
					"include": {
						"headdirection": ["CONTEXTVAL","DIR"]
					}
				}
			}
		},
		"findphalanxmembers": {
			"type":"walker",
			"dir": ["RELATIVEDIR",["VAL",5],["LOOKUP","potentialtail",["MARKPOS","selecttail"],"headdirection"]],
			"start": ["MARKPOS","selecttail"],
			"stoplayer": "selecthead",
			"draw": {
				"start": {
					"tolayer": "phalanxend",
					"include": {
						"facing": ["LOOKUP","potentialtail",["MARKPOS","selecttail"],"headdirection"],
						"strength": ["CONTEXTVAL","LENGTH"]
					}
				},
				"stop": {
					"tolayer": "phalanxend",
					"include": {
						"facing": ["CONTEXTVAL","DIR"],
						"strength": ["CONTEXTVAL","LENGTH"]
					}
				},
				"all": {
					"tolayer": "phalanxmember"
				}
			}
		},
		"findmarchandchargetargets": {
			"type": "walker",
			"starts": ["FROMALLINLAYER","phalanxend"],
			"dir": ["LOOKUP","phalanxend",["CONTEXTPOS","START"],"facing"],
			"stoplayer": "UNITS",
			"max": ["SUM",["VAL",1],["LOOKUP","phalanxend",["CONTEXTPOS","START"],"strength"]],
			"draw": {
				"step": {
					"tolayer": "marchtarget",
					"include": {
						"strength": ["LOOKUP","phalanxend",["CONTEXTPOS","START"],"strength"],
						"heading": ["CONTEXTVAL","DIR"]
					}
				},
				"stop": {
					"condition": ["ANYAT","OPPUNITS",["CONTEXTPOS","TARGET"]],
					"tolayer": "threatened",
					"include": {
						"strength": ["LOOKUP","phalanxend",["CONTEXTPOS","START"],"strength"],
						"heading": ["CONTEXTVAL","DIR"]
					}
				}
			}
		},
		"findopposingphalanx": {
			"type": "walker",
			"starts": ["FROMALLINLAYER","threatened"],
			"dir": ["LOOKUP","threatened",["CONTEXTPOS","START"],"heading"],
			"steplayer": "OPPUNITS",
			"draw": {
				"start": {
					"condition": ["MORE",["LOOKUP","threatened",["CONTEXTPOS","START"],"strength"],["CONTEXTVAL","LENGTH"]],
					"tolayer": "chargetarget",
					"include": {
						"heading": ["CONTEXTVAL","DIR"]
					}
				},
				"all": {
					"tolayer": "opposingphalanx",
					"include": {
						"heading": ["CONTEXTVAL","DIR"]
					}
				}
			}
		}
	}
}