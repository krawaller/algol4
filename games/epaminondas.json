{
	"name": "Epaminondas",
	"source": "https://boardgamegeek.com/filepage/55902/epaminondas-rules-nestorgames",
	"board": { "height": 12, "width": 14 },
	"graphics": { "tiles": {"bases":"grass"}, "icons": {"soldiers":"pawns"} },
	"setup": { "soldiers": [ ["rectangle",1001,2014,{"owner":1}], ["rectangle",11001,12014,{"owner":2}] ] },
	"terrain": { "bases": [ ["rectangle",1001,1014,{"owner":1}], ["rectangle",12001,12014,{"owner":2}] ] },
	"marks": {
		"selecthead": {
			"from": "myunits",
			"rungenerators": ["findimmediatetargets","findpotentialtails"],
			"requiredby": ["selecttail","selectmove","selectcharge","selectmarch"]
		},
		"selecttail": {
			"from": "potentialtail",
			"rungenerators": ["findphalanxmembers","findmarchandchargetargets","findopposingphalanx"],
			"notifhasmark": ["selectmove"],
			"requiredby": ["selectcharge","selectmarch"]
		},
		"selectmove": {
			"from": "movetarget"
		},
		"selectcharge": {
			"from": "chargetarget",
			"notifhasmark": ["selectmarch"],
			"rungenerators": ["findchargevictims"]
		},
		"selectmarch": {
			"from": "marchtarget"
		}
	},
	"commands": {
		"move": {
			"requiredmarks": ["selecthead","selectmove"],
			"effect": ["moveunit",["idofunitat","selecthead"],"selectmove"]
		},
		"march": {
			"requiredmarks": ["selecthead","selecttail","selectmarch"],
			"effect": ["forallin","phalanxmember",
				["offsetunit",["loopid"],
					["lookup","marchtarget",["markpos","selectmarch"],"heading"],
					["lookup","marchtarget",["markpos","selectmarch"],"distance",
					0]]
			]
		},
		"charge": {
			"requiredmarks": ["selecthead","selecttail","selectcharge"],
			"effect": ["multieffect",[
				["forallin","chargevictims",
					["killunit",["loopid"]]
				],
				["forallin","phalanxmember",
					["offsetunit",["loopid"],
						["lookup","chargetarget",["markpos","selectcharge"],"heading"],
						["lookup","chargetarget",["markpos","selectcharge"],"distance",
						0]]
				]
			]]
		}
	},
	"startturn": {
	},
	"endturn": {
		"condition":["same",["contextval","performedsteps"],1],
		"commandcap": true,
		"endgame": {
			"dominance": {
				"condition": ["morethan",
					["positionsin",["intersect","myunits","oppbases"]],
					["positionsin",["intersect","oppunits","mybases"]]
				],
				"result": "win"
			}
		}
	},
	"generators": {
		"findchargevictims": {
			"type": "filter",
			"layer": "opposingphalanx",
			"matching": {"heading":["is",["lookup","opposingphalanx",["markpos","selectcharge"],"heading"]]},
			"tolayer": "chargevictims"
		},
		"findimmediatetargets": {
			"type": "nextto",
			"starts": "selecthead",
			"draw": {
				"target": {
					"condition": ["noneat","units",["contextpos","target"]],
					"tolayer":  "movetarget",
					"include": {
						"singledir": ["contextval","dir"]
					}
				}
			}
		},
		"findpotentialtails": {
			"type": "walker",
			"starts": "selecthead",
			"steps": "myunits",
			"draw": {
				"steps": {
					"tolayer": "potentialtail",
					"include": {
						"headdirection": ["contextval","dir"]
					}
				}
			}
		},
		"findphalanxmembers": {
			"type":"walker",
			"dirs": ["relativedirs",["dirs",[5]],["lookup","potentialtail","selecttail","headdirection"]],
			"starts": "selecttail",
			"blocks": "selecthead",
			"draw": {
				"start": {
					"tolayer": "phalanxend",
					"include": {
						"facing": ["lookup","potentialtail","selecttail","headdirection"],
						"strength": ["sum",1,["contextval","linelength"]]
					}
				},
				"block": {
					"tolayer": "phalanxend",
					"include": {
						"facing": ["contextval","dir"],
						"strength": ["sum",1,["contextval","linelength"]]
					}
				},
				"all": {
					"tolayer": "phalanxmember"
				}
			}
		},
		"findmarchandchargetargets": {
			"type": "walker",
			"starts": "phalanxend",
			"dirs": ["dir",["lookup","phalanxend",["contextpos","start"],"facing"]],
			"blocks": "units",
			"max": ["sum",1,["lookup","phalanxend",["contextpos","start"],"strength"]],
			"draw": {
				"steps": {
					"tolayer": "marchtarget",
					"include": {
						"strength": ["lookup","phalanxend",["contextpos","start"],"strength"],
						"distance": ["contextval","step"],
						"heading": ["contextval","dir"]
					}
				},
				"block": {
					"condition": ["anyat","oppunits",["contextpos","target"]],
					"tolayer": "threatened",
					"include": {
						"strength": ["lookup","phalanxend",["contextpos","start"],"strength"],
						"distance": ["sum",1,["contextval","linelength"]],
						"heading": ["contextval","dir"]
					}
				}
			}
		},
		"findopposingphalanx": {
			"type": "walker",
			"starts": "threatened",
			"dirs": ["dir",["lookup","threatened",["contextpos","start"],"heading"]],
			"steps": "oppunits",
			"draw": {
				"start": {
					"condition": ["morethan",["lookup","threatened",["contextpos","start"],"strength"],["contextval","linelength"]],
					"tolayer": "chargetarget",
					"include": {
						"heading": ["contextval","dir"],
						"distance": ["lookup","threatened",["contextpos","start"],"distance"]
					}
				},
				"all": {
					"tolayer": "opposingphalanx",
					"include": {
						"heading": ["contextval","dir"]
					}
				}
			}
		}
	}
}