{
	"source": "https://boardgamegeek.com/filepage/55902/epaminondas-rules-nestorgames",
	"board": {
		"shape": "square",
		"height": 12,
		"width": 14
	},
	"setup": [
		["list",[1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1011,1012,1013,1014],{"owner":1}],
		["list",[2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011,2012,2013,2014],{"owner":1}],
		["list",[11012,11002,11003,11004,11005,11006,11007,11008,11009,11010,11011,11012,11013,11014],{"owner":2}],
		["list",[12012,12002,12003,12004,12005,12006,12007,12008,12009,12010,12011,12012,12013,12014],{"owner":2}]
	],
	"terrain": {
		"bases": [
			["list",[1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1011,1012,1013,1014],{"owner":1}],
			["list",[12012,12002,12003,12004,12005,12006,12007,12008,12009,12010,12011,12012,12013,12014],{"owner":2}]
		]
	},
	"layers": {
		"movetarget": {
			"paintedby": ["findimmediatetargets"],
			"marks": ["selecthead"]
		},
		"potentialdueltarget": {
			"paintedby": ["findimmediatetargets"],
			"startfor": ["finddueltargets"]
		},
		"dueltarget": {
			"paintedby": ["finddueltargets"],
			"marks": ["selectduel"]
		},
		"potentialtail": {
			"paintedby": ["findpotentialtails"],
			"marks": ["selecttail"]
		},
		"phalanxmember": {
			"paintedby": ["findphalanxmembers"]
		},
		"phalanxend": {
			"paintedby": ["findphalanxmembers"]
		},
		"marchtarget": {
			"paintedby": ["findmarchandchargetargets"],
			"marks": ["selectmarch"]
		},
		"threatened": {
			"paintedby": ["findmarchandchargetargets"]
		},
		"chargetarget": {
			"paintedby": ["findopposingphalanx"],
			"marks": ["selectcharge"]
		},
		"opposingphalanx": {
			"paintedby": ["findopposingphalanx"]
		},
		"chargevictims": {
			"paintedby": ["findchargevictims"]
		},
		"myinfiltrators": {
			"paintedby": ["findinfiltrators"]
		},
		"oppinfiltrators": {
			"paintedby": ["findinfiltrators"]
		}
	},
	"flow": {
		"MARK:selecthead": {
			"GENERATor:findimmediatetargets": ["potentialdueltarget","movetarget"],
			"GENERATor:finddueltargets": ["dueltarget"],
			"GENERATor:findpotentialtails": ["potentialtail"],
			"MARK:selectmove": {
				"COMMandS":["move"]
			},
			"MARK:selectduel": {
				"COMMandS":["duel"]
			},
			"MARK:selecttail": {
				"GENERATor:findphalanxmembers": ["phalanxmember","phalanxend"],
				"GENERATor:findmarchandchargetargets": ["marchtarget","threatened"],
				"GENERATor:findopposingphalanx": ["chargetarget","opposingphalanx"],
				"MARK:selectcharge": {
					"GENERATor:findchargevictims": ["chargevictims"],
					"COMMandS": ["charge"]
				},
				"MARK:selectmarch": {
					"COMMandS": ["march"]
				}
			}
		}
	},
	"marks": {
		"selecthead": {
			"from": "myunits",
			"hydration": ["findimmediatetargets","finddueltargets","findpotentialtails"],
			"cleanse": ["movetarget","dueltarget","potentialtail"]
		},
		"selecttail": {
			"from": "potentialtail",
			"hydration": ["findphalanxmembers","findmarchandchargetargets","findopposingphalanx"],
			"cleanse": ["phalanxmember","phalanxend","chargetarget","opposingphalanx"]
		},
		"selectmove": {
			"from": "movetarget",
			"notwith": ["selecttail","selectcharge","selectmarch","selectduel"]
		},
		"selectduel": {
			"from": "dueltarget",
			"notwith": ["selecttail","selectcharge","selectmarch","selectmove"]
		},
		"selectcharge": {
			"from": "chargetarget",
			"notwith": ["selectmarch","selectmove","selectduel"],
			"hydration": ["findchargevictims"],
			"cleanse": ["chargevictims"]
		},
		"selectmarch": {
			"from": "marchtarget",
			"notwith": ["selectcharge","selectmove","selectduel"]
		}
	},
	"commands": {
		"move": {
			"neededmarks": ["selecthead","selectmove"],
			"effects": [
				["moveunit",["idofunitat",["markpos","selecthead"]],["markpos","selectmove"]]
			]
		},
		"duel": {
			"neededmarks": ["selecthead","selectduel"],
			"effects": [
				["killunit",["idofunitat",["markpos","selectduel"]]],
				["moveunit",["idofunitat",["markpos","selecthead"]],["markpos","selectduel"]]
			]
		},
		"march": {
			"neededmarks": ["selecthead","selecttail","selectmarch"],
			"effects": [
				["forallin","phalanxmember",
					["OFFSETUNIT",["loopid"],
						["lookup","marchtarget",["markpos","selectmarch"],"heading"],
						["lookup","marchtarget",["markpos","selectmarch"],"strength",
						0]]
				]
			]
		},
		"charge": {
			"neededmarks": ["selecthead","selecttail","selectcharge"],
			"effects": [
				["forallin","phalanxmember",
					["OFFSETUNIT",["loopid"],
						["lookup","marchtarget",["markpos","selectcharge"],"heading"],
						["lookup","marchtarget",["markpos","selectcharge"],"strength",
						0]]
				],
				["forallin","chargevictims",
					["killunit",["loopid"]]
				]
			]	
		}
	},
	"startturn": {
		"hydration": []
	},
	"endturn": {
		"condition":["same",["contextval","performedsteps"],["val",2]],
		"commandcap": true,
		"endgame": {
			"dominance": {
				"hydration": ["findinfiltrators"],
				"condition": ["morethan",
					["positionsin","myinfiltrators"],
					["positionsin","oppinfiltrators"]
				]
			}
		}
	},
	"generators": {
		"findinfiltrators": {
			"type": "filter",
			"layer": "bases",
			"condition": ["anyat","units",["contextpos","start"]],
			"matching": {"owner":["isnt",["lookup","units",["contextpos","start"],"owner"]]},
			"tolayer": ["ifelse",["anyat","myunits",["contextpos","start"]],"myinfiltrators","oppinfiltrators"]
		},
		"findchargevictims": {
			"type": "filter",
			"layer": "opposingphalanx",
			"matching": {"heading":["is",["lookup","opposingphalanx",["markpos","selectcharge"],"heading"]]},
			"tolayer": "chargevictims"
		},
		"findimmediatetargets": {
			"type": "neighbour",
			"dirs": ["dirs",[1,2,3,4,5,6,7,8]],
			"starts": ["markpos","selecthead"],
			"draw": {
				"target": {
					"condition": ["noneat","myunits",["contextpos","target"]],
					"tolayer": ["ifelse",
						["anyat","oppunits",["contextpos","target"]],
						"potentialdueltarget",
						"movetarget"
					],
					"include": {
						"singledir": ["contextval","dir"]
					}
				}
			}
		},
		"finddueltargets": {
			"type": "neighbour",
			"starts": ["allposinlayer","potentialdueltarget"],
			"dirs": ["relativedirs",[1],["lookup",["contextpos","start"],"singledir"]],
			"draw": {
				"start": {
					"condition": ["noneat","oppunits",["contextpos","target"]],
					"tolayer": "dueltarget"
				}
			}
		},
		"findpotentialtails": {
			"type": "walker",
			"dirs": ["dirs",[1,2,3,4,5,6,7,8]],
			"starts": ["markpos","selecthead"],
			"steplayer": "myunits",
			"draw": {
				"step": {
					"tolayer": "potentialtail",
					"include": {
						"headdirection": ["contextval","dir"]
					}
				}
			}
		},
		"findphalanxmembers": {
			"type":"walker",
			"dir": ["relativedir",["val",5],["lookup","potentialtail",["markpos","selecttail"],"headdirection"]],
			"starts": ["markpos","selecttail"],
			"stoplayer": "selecthead",
			"draw": {
				"start": {
					"tolayer": "phalanxend",
					"include": {
						"facing": ["lookup","potentialtail",["markpos","selecttail"],"headdirection"],
						"strength": ["contextval","LENGTH"]
					}
				},
				"stop": {
					"tolayer": "phalanxend",
					"include": {
						"facing": ["contextval","dir"],
						"strength": ["contextval","LENGTH"]
					}
				},
				"all": {
					"tolayer": "phalanxmember"
				}
			}
		},
		"findmarchandchargetargets": {
			"type": "walker",
			"starts": ["allposinlayer","phalanxend"],
			"dir": ["lookup","phalanxend",["contextpos","start"],"facing"],
			"stoplayer": "units",
			"max": ["sum",["val",1],["lookup","phalanxend",["contextpos","start"],"strength"]],
			"draw": {
				"step": {
					"tolayer": "marchtarget",
					"include": {
						"strength": ["lookup","phalanxend",["contextpos","start"],"strength"],
						"heading": ["contextval","dir"]
					}
				},
				"stop": {
					"condition": ["anyat","oppunits",["contextpos","target"]],
					"tolayer": "threatened",
					"include": {
						"strength": ["lookup","phalanxend",["contextpos","start"],"strength"],
						"heading": ["contextval","dir"]
					}
				}
			}
		},
		"findopposingphalanx": {
			"type": "walker",
			"starts": ["allposinlayer","threatened"],
			"dir": ["lookup","threatened",["contextpos","start"],"heading"],
			"steplayer": "oppunits",
			"draw": {
				"start": {
					"condition": ["morethan",["lookup","threatened",["contextpos","start"],"strength"],["contextval","LENGTH"]],
					"tolayer": "chargetarget",
					"include": {
						"heading": ["contextval","dir"]
					}
				},
				"all": {
					"tolayer": "opposingphalanx",
					"include": {
						"heading": ["contextval","dir"]
					}
				}
			}
		}
	}
}