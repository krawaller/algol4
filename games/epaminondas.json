{
	"source": "https://boardgamegeek.com/filepage/55902/epaminondas-rules-nestorgames",
	"board": {
		"shape": "square",
		"height": 12,
		"width": 14,
		"setup": [
		]
	},
	"marks": {
		"selecthead": {
			"from": "MYUNITS"
		},
		"selecttail": {
			"from": "potentialtail"
		},
		"selectmove": {
			"from": "movetarget",
			"notwith": "selecttail"
		},
		"selectkill": {
			"from": "killtarget",
			"notwith": "selectmarch"
		},
		"selectmarch": {
			"from": "marchtarget"
		}
	},
	"commands": {
		"move": {
			"effects": [
				["MOVEUNIT",["IDAT",["MARKPOS","selecthead"]],["MARKPOS","movetarget"]]
			]
		},
		"march": {
			"effects": [
				["FORALLIN","phalanxmember",
					["OFFSETUNIT",["LOOPID"],
						["LOOKUP","marchtarget",["MARKPOS","selectmarch"],"heading"],
						["LOOKUP","marchtarget",["MARKPOS","selectmarch"],"strength",
						0]]
				]
			]
		},
		"charge": {
			"effects": [
				["FORALLIN","phalanxmember",
					["OFFSETUNIT",["LOOPID"],
						["LOOKUP","marchtarget",["MARKPOS","selectkill"],"heading"],
						["LOOKUP","marchtarget",["MARKPOS","selectkill"],"strength",
						0]]
				],
				["FORALLIN","doomed",
					["KILLUNIT",["LOOPID"]]
				]
			]	
		}
	},
	"generators": {
		"finddoomed": {
			"type": "filter",
			"layer": "tokill",
			"matching": {"heading":["IS",["LOOKUP","tokill",["MARKPOS","selectkill"],"heading"]]},
			"tolayer": "doomed"
		},
		"movetarget": {
			"type": "neighbour",
			"dirs": ["DIRS",1,2,3,4,5,6,7,8],
			"start": ["MARKPOS","selecthead"],
			"draw": {
				"target": {
					"condition": ["NONEAT","UNITS",["CONTEXTPOS","TARGET"]],
					"tolayer": "movetarget"
				}
			}
		},
		"potentialphalanx": {
			"type": "walker",
			"dirs": ["DIRS",1,2,3,4,5,6,7,8],
			"start": ["MARKPOS","selecthead"],
			"steplayer": "MYUNITS",
			"draw": {
				"step": {
					"tolayer": "potentialtail",
					"include": {
						"headdirection": ["CONTEXTVAL","DIR"]
					}
				}
			}
		},
		"paintphalanx": {
			"type":"walker",
			"dir": ["RELATIVEDIR",["VAL",5],["LOOKUP","potentialtail",["MARKPOS","selecttail"],"headdirection"]],
			"start": ["MARKPOS","selecttail"],
			"stoplayer": "selecthead",
			"draw": {
				"start": {
					"tolayer": "phalanxend",
					"include": {
						"facing": ["LOOKUP","potentialtail",["MARKPOS","selecttail"],"headdirection"],
						"strength": ["CONTEXTVAL","LENGTH"]
					}
				},
				"stop": {
					"tolayer": "phalanxend",
					"include": {
						"facing": ["CONTEXTVAL","DIR"],
						"strength": ["CONTEXTVAL","LENGTH"]
					}
				},
				"all": {
					"tolayer": "phalanxmember"
				}
			}
		},
		"march": {
			"type": "walker",
			"starts": ["FROMALLINLAYER","phalanxend"],
			"dir": ["LOOKUP","phalanxend",["CONTEXTPOS","START"],"facing"],
			"stoplayer": "UNITS",
			"max": ["SUM",["VAL",1],["LOOKUP","phalanxend",["CONTEXTPOS","START"],"strength"]],
			"draw": {
				"step": {
					"tolayer": "marchtarget",
					"include": {
						"strength": ["LOOKUP","phalanxend",["CONTEXTPOS","START"],"strength"],
						"heading": ["CONTEXTVAL","DIR"]
					}
				},
				"stop": {
					"condition": ["ANYAT","OPPUNITS",["CONTEXTPOS","TARGET"]],
					"tolayer": "threatened",
					"include": {
						"strength": ["LOOKUP","phalanxend",["CONTEXTPOS","START"],"strength"],
						"heading": ["CONTEXTVAL","DIR"]
					}
				}
			}
		},
		"opposers": {
			"type": "walker",
			"starts": ["FROMALLINLAYER","threatened"],
			"dir": ["LOOKUP","threatened",["CONTEXTPOS","START"],"heading"],
			"steplayer": "OPPUNITS",
			"draw": {
				"start": {
					"condition": ["MORE",["LOOKUP","threatened",["CONTEXTPOS","START"],"strength"],["CONTEXTVAL","LENGTH"]],
					"tolayer": "killtarget",
					"include": {
						"heading": ["CONTEXTVAL","DIR"]
					}
				},
				"all": {
					"tolayer": "tokill",
					"include": {
						"heading": ["CONTEXTVAL","DIR"]
					}
				}
			}
		}
	}
}